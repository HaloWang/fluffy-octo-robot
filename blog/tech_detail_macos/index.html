<!doctype html>
<html lang="zh-Hans" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.1">
<title data-rh="true">Valo Reader for macOS 技术概要 | Valo Reader</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://your-docusaurus-site.example.com/valo-reader-doc/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://your-docusaurus-site.example.com/valo-reader-doc/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://your-docusaurus-site.example.com/valo-reader-doc/blog/tech_detail_macos"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Valo Reader for macOS 技术概要 | Valo Reader"><meta data-rh="true" name="description" content="摘要"><meta data-rh="true" property="og:description" content="摘要"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-10-19T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/haloWang"><meta data-rh="true" property="article:tag" content="technical"><link data-rh="true" rel="icon" href="/valo-reader-doc/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://your-docusaurus-site.example.com/valo-reader-doc/blog/tech_detail_macos"><link data-rh="true" rel="alternate" href="https://your-docusaurus-site.example.com/valo-reader-doc/blog/tech_detail_macos" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://your-docusaurus-site.example.com/valo-reader-doc/blog/tech_detail_macos" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/valo-reader-doc/blog/rss.xml" title="Valo Reader RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/valo-reader-doc/blog/atom.xml" title="Valo Reader Atom Feed"><link rel="stylesheet" href="/valo-reader-doc/assets/css/styles.1068f7e9.css">
<script src="/valo-reader-doc/assets/js/runtime~main.831ed899.js" defer="defer"></script>
<script src="/valo-reader-doc/assets/js/main.e823cf6b.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/valo-reader-doc/"><div class="navbar__logo"><img src="/valo-reader-doc/img/logo.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/valo-reader-doc/img/logo.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Valo Reader</b></a><a class="navbar__item navbar__link" href="/valo-reader-doc/docs/intro">文档</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/valo-reader-doc/blog">博客</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/valo-reader-doc/blog/tech_detail_macos">Valo Reader for macOS 技术概要</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/valo-reader-doc/blog/motivation">开发目的</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="https://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="摘要"><header><h1 class="title_f1Hy" itemprop="headline">Valo Reader for macOS 技术概要</h1><div class="container_mt6G margin-vert--md"><time datetime="2023-10-19T00:00:00.000Z" itemprop="datePublished">2023年10月19日</time> · <!-- -->阅读需 24 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/haloWang" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/haloWang.png" alt="Ce Wang" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/haloWang" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Ce Wang</span></a></div><small class="avatar__subtitle" itemprop="description">Solo dev</small></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="摘要">摘要<a href="#摘要" class="hash-link" aria-label="摘要的直接链接" title="摘要的直接链接">​</a></h2>
<p>本文主要介绍了 Valo Reader for macOS（下文简称为“本程序”）的<a href="#%E9%A1%B9%E7%9B%AE%E5%B8%83%E5%B1%80">项目布局</a>，<a href="#%E5%B7%A5%E7%A8%8B%E6%9E%B6%E6%9E%84">工程架构</a>，<a href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E5%8A%9F%E8%83%BD%E6%A8%A1%E5%9D%97">运行时功能模块</a>与<a href="#%E6%8A%80%E6%9C%AF%E7%BB%86%E8%8A%82">技术细节</a>。你还可以在<a href="/valo-reader-doc/docs/intro">本文档</a>的其他页面了解本程序的<a href="/valo-reader-doc/blog/motivation">开发动机</a>，<a href="/valo-reader-doc/docs/usage">使用方式</a>，<a href="/valo-reader-doc/docs/privacy_security">隐私与安全</a>等内容</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="什么是-valo-reader">什么是 Valo Reader?<a href="#什么是-valo-reader" class="hash-link" aria-label="什么是 Valo Reader?的直接链接" title="什么是 Valo Reader?的直接链接">​</a></h2>
<p>Valo Reader 这个项目是我个人在日常生活中逐渐萌生，演化和实施的想法。是我为了在自己电子设备设备上能轻松阅读英文内容，并渐近式地提高自己的英文水平，而自行设计和研发的一款产品，其核心功能展示如下：
<img loading="lazy" alt="intro" src="/valo-reader-doc/assets/images/intro-663e889360c7a0e605df52af33af3b11.gif" width="960" height="268" class="img_ev3q"></p>
<p>当你在使用本程序时，将鼠标移动至你感到生疏的英语单词上。按下指定的按键（默认为 Fn），本程序即会在鼠标指针所在的位置展示对应单词的释义，同时使用语音合成来发音。</p>
<p>目前，你可以通过 <a href="https://apps.apple.com/cn/app/valo-reader/id6448040931" target="_blank" rel="noopener noreferrer">Mac App Store</a> 或<a href="/valo-reader-doc/docs/installation">其他方式</a>来获取本程序</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="项目布局">项目布局<a href="#项目布局" class="hash-link" aria-label="项目布局的直接链接" title="项目布局的直接链接">​</a></h2>
<p>下图展示了本项目的主体结构：
<img loading="lazy" alt="project_layout" src="/valo-reader-doc/assets/images/project_layout-b9e52932db96541ab24f4ed06bc28bc0.png" width="1996" height="960" class="img_ev3q"></p>
<p>本文位于上图中的浅黄色部分，由 <a href="https://docusaurus.io/" target="_blank" rel="noopener noreferrer">docusaurus</a> 生成</p>
<p>本项目的想法最早实现于在浏览器中运行的 js 脚本，你可以在 github 上看到本项目在浏览器上的早期实现及对应的<a href="https://github.com/HaloWang/english_flow#%E5%8A%9F%E8%83%BD%E5%B1%95%E7%A4%BA" target="_blank" rel="noopener noreferrer">功能展示</a>，即图中浅绿色部分</p>
<p>而本文主要说明了上图中 macOS（浅蓝色部分）的运行方式与技术细节</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="工程架构">工程架构<a href="#工程架构" class="hash-link" aria-label="工程架构的直接链接" title="工程架构的直接链接">​</a></h2>
<p>本程序由 <code>flutter create XXX --platform macos</code> 命令创建，其源代码主要分为两部分</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="flutter-侧">flutter 侧<a href="#flutter-侧" class="hash-link" aria-label="flutter 侧的直接链接" title="flutter 侧的 直接链接">​</a></h3>
<p>这部分由 dart 编写，可分为三部分</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="主程序">主程序<a href="#主程序" class="hash-link" aria-label="主程序的直接链接" title="主程序的直接链接">​</a></h4>
<p>该部分的主要功能有：</p>
<ol>
<li>通过 method channel 实现 flutter 与 native 的交互</li>
<li>渲染用户设置面板（Dashboard）</li>
<li>渲染释义展示面板（HUD）与诊断检查信息</li>
<li>使用第三方依赖提供的功能</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="flutter-package-文本块表征">flutter package: 文本块表征<a href="#flutter-package-文本块表征" class="hash-link" aria-label="flutter package: 文本块表征的直接链接" title="flutter package: 文本块表征的直接链接">​</a></h4>
<p>这部分是本程序的核心代码，在 macOS / iOS / Android 三端共享部分逻辑与 UI，其主要功能由有：</p>
<ol>
<li>解析用户设备屏幕上识别到的文本块，结构化文本块，并将其维护到本程序的内存中</li>
<li>声明并实现用户视觉焦点与已知的文本信息的交互</li>
<li>渲染释义展示面板（HUD）</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="flutter-package-基础库">flutter package: 基础库<a href="#flutter-package-基础库" class="hash-link" aria-label="flutter package: 基础库的直接链接" title="flutter package: 基础库的直接链接">​</a></h4>
<p>在我的所有 flutter 项目中共享的基础依赖</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="native-侧">native 侧<a href="#native-侧" class="hash-link" aria-label="native 侧的直接链接" title="native 侧的直接链接">​</a></h3>
<p>这部分由 swift 编写，可分为三部分</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="主程序部分">主程序部分<a href="#主程序部分" class="hash-link" aria-label="主程序部分的直接链接" title="主程序部分的直接链接">​</a></h4>
<p>持有 flutter engine，通过 method channel 打通 flutter 与 <code>Base</code>、<code>OCR</code> 以及应用程序本身的双向调用</p>
<p>创建项目时默认的 <code>FlutterViewController</code> 已被删除</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="cocoapods-dependency-cocoa-功能库">CocoaPods dependency: Cocoa 功能库<a href="#cocoapods-dependency-cocoa-功能库" class="hash-link" aria-label="CocoaPods dependency: Cocoa 功能库的直接链接" title="CocoaPods dependency: Cocoa 功能库的直接链接">​</a></h4>
<p>与 Cocoa framework 交互，如：权限申请，键盘监听，鼠标监听，截取屏幕，移动承载 flutter 的 <code>NSWindow</code>以及提供基本若干原生能力</p>
<p>该部分使用 CocoaPods 创建，我也会在该依赖中学习，尝试和实现 Cocoa/AppKit 独有的 API 与功能</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="cocoapods-dependency-ocr-功能库">CocoaPods dependency: OCR 功能库<a href="#cocoapods-dependency-ocr-功能库" class="hash-link" aria-label="CocoaPods dependency: OCR 功能库的直接链接" title="CocoaPods dependency: OCR 功能库的直接链接">​</a></h4>
<p>与 <a href="https://developer.apple.com/documentation/vision/recognizing_text_in_images" target="_blank" rel="noopener noreferrer">Apple Vision framework - Text Recognizing</a> 交互，并实现部分逻辑，如：发起文本识别请求，维护文本识别响应缓存</p>
<p>该部分使用 CocoaPods 创建，在 macOS 和 iOS 项目同时依赖并共享代码</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="运行时功能模块">运行时功能模块<a href="#运行时功能模块" class="hash-link" aria-label="运行时功能模块的直接链接" title="运行时功能模块的直接链接">​</a></h2>
<p>在运行时，本程序主要可分为用户设置面板 (Dashboard)、释义展示面板 (HUD) 和原生侧 (native) 三个模块</p>
<p>下图展示了本程序在运行时的主要模块及其通讯：
<img loading="lazy" alt="modules_light" src="/valo-reader-doc/assets/images/modules_light-980bb1be0d553350c1dcf22e0b4325e2.png#gh-light-mode-only" width="1926" height="894" class="img_ev3q">
<img loading="lazy" alt="modules_dark" src="/valo-reader-doc/assets/images/modules_dark-ede87b48b4273a15fc0974c77b5586cf.png#gh-dark-mode-only" width="1926" height="894" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="释义展示面板-hud">释义展示面板 (HUD)<a href="#释义展示面板-hud" class="hash-link" aria-label="释义展示面板 (HUD)的直接链接" title="释义展示面板 (HUD)的直接链接">​</a></h3>
<p>HUD 是一个的 <code>NSPanel</code>(<code>NSWindow</code> 的子类)实例，其内部承载了一个 <code>FlutterViewController</code>，并绑定了自己的 <code>FlutterEngine</code> 和 <code>FlutterMethodChannel</code></p>
<p>HUD 的主要任务包含：</p>
<ul>
<li>通过 <code>FlutterMethodChannel</code> 向 native 派发 ocr 请求</li>
<li>解析 native 对屏幕指定区域的 ocr 结果，并在内存中维护该结果供后继程序逻辑使用</li>
<li>监听鼠标位置以在需要时计算释义展示的位置</li>
<li>监听键盘按键状态，在变化时派发 ocr 请求并展示单词释义</li>
<li>实时同步 Dashboard engine 传递过来的用户设置，并修改展示逻辑</li>
</ul>
<p>下图展示了该模块所维护的数据映射到屏幕上时的可视化效果：
<img loading="lazy" alt="text_block_representation" src="/valo-reader-doc/assets/images/text_block_representation-e7dc02491d5b436f2ef66bd928e65e17.png" width="1898" height="222" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="在-hud-中的状态">在 HUD 中的状态<a href="#在-hud-中的状态" class="hash-link" aria-label="在 HUD 中的状态的直接链接" title="在 HUD 中的状态的直接链接">​</a></h4>
<p>本程序使用 <a href="https://riverpod.dev/" target="_blank" rel="noopener noreferrer">riverpod</a> 管理绝大部分的状态。在 构筑本程序时，我的思考过程主要基于状态与状态变化，从展示释义键点击到渲染释义面板动画</p>
<p>在大量使用 riverpod 中的 <code>Provider</code> / <code>StateProvider</code> / <code>ProviderContainer.listen</code> 后，我可以构建一个高度异步，调用顺序不敏感，状态变化驱动的应用程序。在编码过程中，这种方式让程序员可以从一大串的命令式(Imperative)方法调用中解放出来，仅仅需要关注和确保每个最小逻辑单元——<code>Provider</code>，确保其实现是正确的即可，这减少了构建复杂和长串逻辑出错的可能</p>
<p>下面的两张图表展示了本程序的主要功能流程</p>
<p>切换展示释义流程：</p>
<!-- -->
<p>用户关注文本块变更流程：</p>
<!-- -->
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="用户设置面板-dashboard">用户设置面板 (Dashboard)<a href="#用户设置面板-dashboard" class="hash-link" aria-label="用户设置面板 (Dashboard)的直接链接" title="用户设置面板 (Dashboard)的直接链接">​</a></h3>
<p>Dashboard 是一个 <code>NSWindow</code> 实例，其内部承载了一个 <code>FlutterViewController</code>，并绑定了不同于 HUD 的独立 engine 与 method channel</p>
<p>Dashboard 的主要任务是为用户提供控制本程序的 UI，包括快捷键设置，开机自启，关于本程序等常见用户交互</p>
<p>同时，Dashboard 会维护本程序在内存和硬盘中的状态，并将这个状态通过 method channel 同步至下面即将要讲到的释义展示面板</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="原生侧-native">原生侧 (native)<a href="#原生侧-native" class="hash-link" aria-label="原生侧 (native)的直接链接" title="原生侧 (native)的直接链接">​</a></h3>
<p>原生侧是由 <code>flutter create</code> 命令创建出来的传统 Xcode 工程</p>
<p>在原生侧，我主要关注的问题如下：</p>
<ul>
<li>处理来自 <code>FlutterMethodChannel</code> 的调用，并在需要时通过 <code>FlutterResult</code> 响应对应的 flutter engine</li>
<li>维护承载 HUD 和 Dashboard 的两个 <code>NSWindow</code>，尤其是当用户的设备同时链接多个屏幕时，正确地设置 HUD 的位置</li>
<li>封装并向 flutter 提供能力，如：<!-- -->
<ul>
<li>监听鼠标位置变化和键盘状态变化，并将状态同步至 flutter</li>
<li>为 flutter 提供 OCR 和语音合成能力</li>
<li>在执行 OCR 时使用 swift 实现必要的性能优化</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="技术细节">技术细节<a href="#技术细节" class="hash-link" aria-label="技术细节的直接链接" title="技术细节的直接链接">​</a></h2>
<p>得益于 Apple 一脉相承的 API 设计以及同样的编程语言，熟练于 iOS 应用开发(Cocoa Touch &amp; UIKit)的程序员在面对与 macOS 交互的 Cocoa 和 AppKit 框架时，可以复用很多思想与逻辑</p>
<p>但相比于 iOS，macOS 给了用户更大的舞台，也让开发者面对了更多的挑战: 鼠标，键盘，窗口和屏幕</p>
<p>在开发本程序的过程中，我遇到了诸多的困难，也在茅塞顿开时收获了很多快乐，我在这一章节会记录一下</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="多屏幕">多屏幕<a href="#多屏幕" class="hash-link" aria-label="多屏幕的直接链接" title="多屏幕的直接链接">​</a></h3>
<p>macOS 及其运行的硬件设备常常连接着多块屏幕，本程序的核心功能就是在任意的屏幕位置展示单词释义，这就要确保：</p>
<ol>
<li>将释义展示面板(HUD)放置于正确的位置上</li>
<li>flutter 在请求 native 捕捉屏幕时，捕捉的矩形框的位置正确</li>
<li>flutter 在解析 ocr response 后，结果可以正确地和屏幕上真正的内容建立映射</li>
</ol>
<p>和 UIKit 中常用的 CGRect 不同，AppKit 对设备屏幕的抽象 <code>NSScreen</code>，其坐标以 NSRect 计算，坐标系原点为 macOS 原始屏幕的左下角。而此时，如果你给你的设备连接上了其他的屏幕，<code>NSScreen.screens</code> 所呈现屏幕布局，可能就会变成下图所示的样子：
<img loading="lazy" alt="appkit_screens_coordinate" src="/valo-reader-doc/assets/images/appkit_screens_coordinate-94563877ba8462b8412c6e945e1f7b5e.png" width="1630" height="734" class="img_ev3q"></p>
<p><code>screen 1</code> 的左下角坐标值并非是 (0, 0)，而是 <code>screen 1</code> 和 <code>screen 0</code> 的 (0, 0) 点的相对位置 (w<sub>1</sub>, d<sub>2</sub>)。通过监听鼠标移动事件获取的鼠标位置 <code>event.locationInWindow</code>，也是相对于原点的 <code>NSPoint</code></p>
<p>在开发时，仅仅将自己的思维从 iOS 的 CGRect 坐标系转化至 NSRect 坐标系还算简单。但在后继的逻辑中，因为 OCR 结果的 <code>VNRectangleObservation.boundingBox</code> 又会回到 CGRect 坐标系，坐标系的频繁转化确实会给人带来一定的困扰</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="屏幕捕捉">屏幕捕捉<a href="#屏幕捕捉" class="hash-link" aria-label="屏幕捕捉的直接链接" title="屏幕捕捉的直接链接">​</a></h3>
<p>想捕捉 macOS 的屏幕，你可以调用 <code>CGDisplayCreateImage</code> 函数</p>
<p>但值得注意的是，想要截取屏幕上其他进程的内容(比如 IDE 或者浏览器)，需要预先通过 <code>CGRequestScreenCaptureAccess</code>，申请到截取其他进程 UI 的权限，否则 <code>CGDisplayCreateImage</code> 只能拿到 macOS 的桌面（以及程序本身）</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ocr">OCR<a href="#ocr" class="hash-link" aria-label="OCR的直接链接" title="OCR的直接链接">​</a></h3>
<p>本程序使用 Apple 为开发者提供的 <a href="https://developer.apple.com/documentation/vision/recognizing_text_in_images" target="_blank" rel="noopener noreferrer">Vision - Recognizing Text</a> 进行屏幕文本的提取</p>
<p>OCR 请求的  调用由 flutter side 唤起：</p>
<div class="language-dart codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-dart codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">void dispatchOCRRequestToNative() async {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  final x = 100;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  final y = 100;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  final width = 300;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  final height = 80;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  final dimensions = [x, y, width, height];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  final result = await methodChannel.invokeMethod(&quot;captureAndOCR&quot;, dimensions);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // parse the result from native</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Native side 在接收到请求后，会执行截屏和识别操作：</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token class-name">Vision</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> result </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">FlutterResult</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> image </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">captureScreen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> handler </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">VNImageRequestHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cgImage</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> image</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> request </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">VNRecognizeTextRequest</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> error </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ocr finished</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> parsedResult </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">parse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">results</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">result</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">parsedResult</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">handler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">perform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">request</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="性能表现">性能表现<a href="#性能表现" class="hash-link" aria-label="性能表现的直接链接" title="性能表现的直接链接">​</a></h4>
<p>在 macbook 2021 的 m1 pro 上，以 320✕75 的设计分辨率截图(实际分辨率为 640✕150)，每秒 11 帧的情况下进行长时间的截图和 OCR 操作，整个流程的延迟平均约为 65ms，我认为还算是一个可接受的状态</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="节能优化">节能优化<a href="#节能优化" class="hash-link" aria-label="节能优化的直接链接" title="节能优化的直接链接">​</a></h4>
<p>即便是性能允许，优化也是应该做的，用户一旦使用你的 App，就感觉 macbook 的 C 面发热，这是无法容忍的</p>
<p>当前在 OCR 流程中主要的性能优化步骤是在 native 维护一个先进先出，最大容量为 40 帧的字典，以图片数据为 key 缓存 OCR 的结果，下面是简化后的代码：</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> cacheManager </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">CacheManager</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">CFData</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Result</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> image </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">captureScreen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> image</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dataProvider</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> cachedResult </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> cacheManager</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  delegate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">onOCRResult</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cachedResult</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">dispatchOCRRequestToDeviceGPU</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">image</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cacheManager</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ... other logic</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>当鼠标指针位置不变，截图获取的图片不变时，native 在处理 OCR 请求时会先命中缓存，并直接返回结果，以减少非必需的 GPU 调用</p>
<p>在系统自带的活动监视器中查看进程。发现，在应用的缓存策略后，在本程序活动时，其 CPU/GPU 占用率确实降低了很多，同时，OCR 的缓存结果被降为了 5ms</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>备注</div><div class="admonitionContent_BuS1"><p>我感觉，以 <code>CFData</code> 作为 key 查询字典还不是效率最高的算法，应该可以继续探索一下</p></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="不截取自己">不截取自己<a href="#不截取自己" class="hash-link" aria-label="不截取自己的直接链接" title="不截取自己的直接链接">​</a></h4>
<p>在我进行开发时，发现当本程序在展示单词释义 UI (HUD)时，因为 HUD 本身也会在一定范围内被截屏函数捕获，导致 HUD 会影响 OCR 的结果，而在 OCR 结果变动后，HUD 又会随之发生变动，再次影响 OCR 结果，就这样循环往复，连缓存也都失效了。在查阅和尝试大量的 API 后，我终于在 <code>NSWindow</code> 中找到了 <code>sharingType</code> 这个属性，屏幕捕捉方法捕获 HUD 自身，总算是打破了这个链条</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="结果解析分词与定位">结果解析，分词与定位<a href="#结果解析分词与定位" class="hash-link" aria-label="结果解析，分词与定位的直接链接" title="结果解析，分词与定位的直接链接">​</a></h3>
<p>对 Vision - VNRecognizeTextRequest 的结果解析是个复杂的任务</p>
<p>执行这个复杂任务的原因有三：</p>
<ol>
<li>本程序设计的交互是“用户将鼠标移动至感兴趣的单词上时展示单词释义”，这就要求我们知道屏幕上每个单词的具体位置和内容</li>
<li>本程序针对源代码特化，在面对<a href="https://zh.wikipedia.org/zh-cn/%E9%A9%BC%E5%B3%B0%E5%BC%8F%E5%A4%A7%E5%B0%8F%E5%86%99" target="_blank" rel="noopener noreferrer">驼峰命名法</a>时，需要知道构成一个 symbol 的每个单词的意思：<code>ThisIsAVeryVeryLongClassName</code> -&gt; <code>This</code>,<del><code>Is</code></del>,<del><code>A</code></del>,<code>Very</code>,<code>Very</code>,<code>Long</code>,<code>Class</code>,<code>Name</code> (因过于简单，丢弃长度小于 3 的英语单词)</li>
<li>我们要以单词 的文本内容为 key，查询数据库。在文本序列包含特殊字符时，我们是无法从数据库中查到单词释义的。所以要移除非字母字符。同时，这一操作也可以自然而然地适配编程语言中的其他命名方式，比如移除下划线就可以适应<a href="https://zh.wikipedia.org/zh-cn/%E8%9B%87%E5%BD%A2%E5%91%BD%E5%90%8D%E6%B3%95" target="_blank" rel="noopener noreferrer">蛇形命名法</a></li>
</ol>
<p>假设我们在对下面的图片执行 OCR 请求</p>
<p><img loading="lazy" alt="ocr_text_source" src="/valo-reader-doc/assets/images/ocr_text_source-9af654c22d465590f3079fd8d4f2f24f.png" width="1038" height="198" class="img_ev3q"></p>
<p>在 Native 端取 <code>VNRecognizeTextRequest.results.topCandidates(1)</code> 后，结果如下</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 同时包含 rect 信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string-literal string" style="color:#e3116c">&quot;Vision provides its text-recognition capabilities through VNRecognizeText&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 同时包含 rect 信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string-literal string" style="color:#e3116c">&quot;Request, an image-based request type that finds and extracts text in images. The&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 同时包含 rect 信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string-literal string" style="color:#e3116c">&quot;following example shows how to use VNImageRequestHandler to perform a&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 同时包含 rect 信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string-literal string" style="color:#e3116c">&quot;VNRecognizeTextRequest for recognizing text in the specified CGImage.&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在 Native 端以<strong>空格</strong>字符和 <code>VNRecognizedText.boundingBox(for:)</code> 对 OCR 结果进行第一次整理，上述的结果会变为这样：</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 同时包含 rect 信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string-literal string" style="color:#e3116c">&quot;Vision&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;provides&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;its&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;text-recognition&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;capabilities&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;through&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;VNRecognizeText&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 同时包含 rect 信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string-literal string" style="color:#e3116c">&quot;Request,&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;an&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;image-based&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;request&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;type&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;that&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;finds&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;and&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;extracts&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;text&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;in&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;images.&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;The&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 同时包含 rect 信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string-literal string" style="color:#e3116c">&quot;following&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;example&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;shows&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;how&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;to&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;use&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;VNImageRequestHandler&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;to&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;perform&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;a&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 同时包含 rect 信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string-literal string" style="color:#e3116c">&quot;VNRecognizeTextRequest&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;for&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;recognizing&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;text&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;in&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;the&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;specified&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;CGImage.&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>最后将 boundingBox 的返回值和截屏尺寸进行乘算，返回给 flutter 端。Flutter 端在拿到结果后主要进行两个步骤：</p>
<ol>
<li>将文本视为等宽字体，移除非英文字符，计算新的 rect</li>
<li>将文本视为等宽字体，对包含大写字母的字符串进行分割，计算新的 rect</li>
</ol>
<p>这样，文本块的内容在 flutter 端就会变成这样：</p>
<div class="language-dart codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-dart codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 同时包含 rect 信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;Vision&quot;, &quot;provides&quot;, &quot;its&quot;, &quot;text&quot;, &quot;recognition&quot;, &quot;capabilities&quot;, &quot;through&quot;, &quot;Recognize&quot;, &quot;Text&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 同时包含 rect 信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;Request&quot;,&quot;image&quot;, &quot;based&quot;, &quot;request&quot;, &quot;type&quot;, &quot;that&quot;, &quot;finds&quot;, &quot;and&quot;, &quot;extracts&quot;, &quot;text&quot;, &quot;images&quot;, &quot;The&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 同时包含 rect 信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;following&quot;, &quot;example&quot;, &quot;shows&quot;, &quot;how&quot;, &quot;use&quot;, &quot;Image&quot;, &quot;Request&quot;, &quot;Handler&quot;, &quot;perform&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 同时包含 rect 信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;Recognize&quot;, &quot;Text&quot;, &quot;Request&quot;, &quot;for&quot;, &quot;recognizing&quot;, &quot;text&quot;, &quot;the&quot;, &quot;specified&quot;, &quot;Image&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>最后，flutter 侧会以下面的代码对这些 OCR 信息进行抽象：</p>
<div class="language-dart codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-dart codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/// The representation of block</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">///</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/// 文本块表征</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class Block {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  String text;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  double x;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  double y;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  double w;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  double h;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/// All text representations in memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">///</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/// 所有文本块表征</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">final blocks = StateProvider&lt;List&lt;Block&gt;&gt;((_) =&gt; []);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>上面的数据在屏幕上的可视化效果如下：
<img loading="lazy" alt="text_block_representation_2" src="/valo-reader-doc/assets/images/text_block_representation_1-7c6db883d1b12b61355048e553101f21.png" width="1050" height="184" class="img_ev3q"></p>
<p>其中外围绿框代表截屏范围  ，内部的小绿框代表 native 端返回的结果，小绿框内部的蓝色框代表 flutter side 第二次解析结果。可以看到，<code>&quot;VNImageRequestHandler&quot;</code> 这个字符串被分割为了 <code>&quot;Image&quot;</code>, <code>&quot;Request&quot;</code>, <code>&quot;Handler&quot;</code> 这三个文本块。这样，我就可以知道用户到底对哪一段字母序列（单词）感兴趣了（假设源代码符号的命名是规范的 😇）。</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>备注</div><div class="admonitionContent_BuS1"><p>你也可以打开本程序的用户设置面板来直接观察其运行时表现：
<img loading="lazy" alt="dashboard_inspect" src="/valo-reader-doc/assets/images/dashboard_inspect-0a3c0a7bba8e62a06a697e1555bb3ea4.png" width="970" height="192" class="img_ev3q"></p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="多引擎与状态同步">多引擎与状态同步<a href="#多引擎与状态同步" class="hash-link" aria-label="多引擎与状态同步的直接链接" title="多引擎与状态同步的直接链接">​</a></h3>
<p>本程序在运行时会创建两个 flutter engine，分别用于渲染&quot;释义展示面板(HUD)&quot;和&quot;欢迎与设置页面(Dashboard)&quot;</p>
<p>这两个引擎均通过基本方式创建， 均采用 <code>FlutterMethodChannel</code> 与 native 进行通讯</p>
<p>双引擎共享同一份代码，经由不同的 <a href="https://github.com/dart-lang/sdk/blob/master/runtime/docs/compiler/aot/entry_point_pragma.md" target="_blank" rel="noopener noreferrer">dart 入口函数</a>启动：</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 设置页面 (Dashboard)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dashboardEngine </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">FlutterEngine</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;dashboard&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> project</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token nil constant" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dashboardChannel </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">FlutterMethodChannel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;dashboard&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> binaryMessenger</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> dashboardEngine</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">binaryMessenger</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dashboardEngine</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">withEntrypoint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;_dashboard&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 释义展示面板 (HUD)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hudEngine </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">FlutterEngine</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;hud&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> project</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token nil constant" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hudChannel </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">FlutterMethodChannel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;hud&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> binaryMessenger</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> hudEngine</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">binaryMessenger</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hudChannel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">withEntrypoint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string-literal string" style="color:#e3116c">&quot;_hud&quot;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>备注</div><div class="admonitionContent_BuS1"><p>我个人没有使用官方提供的 <a href="https://docs.flutter.dev/add-to-app/multiple-flutters" target="_blank" rel="noopener noreferrer">FlutterEngineGroup 方案</a>，因为在当初进行尝试时发现了引擎无响应的问题，至今仍然是 P2 级别的 open <a href="https://github.com/flutter/flutter/issues/119403" target="_blank" rel="noopener noreferrer">issue</a></p></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="跨引擎状态同步">跨引擎状态  同步<a href="#跨引擎状态同步" class="hash-link" aria-label="跨引擎状态同步的直接链接" title="跨引擎状态同步的直接链接">​</a></h4>
<p>本程序使用 <a href="https://riverpod.dev/" target="_blank" rel="noopener noreferrer">riverpod</a> 来管理绝大部分状态，所以在同步状态时，我也期望自己的自己的心智模型可以更贴近 riverpod</p>
<p>在运行时，Dashboard engine 需要将用户设置同步至 HUD engine (比如更改查词快捷键)，我在这里监听了 Dashboard engine 对应的 <code>StateProvider</code> 的变更，并通过 method channel，经由 native 转发至 HUD engine，HUD engine 在收到了通知后，再更新自己维护的 <code>StateProvider</code>。从而实现了跨引擎的状态同步</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="释义查询">释义查询<a href="#释义查询" class="hash-link" aria-label="释义查询的直接链接" title="释义查询的直接链接">​</a></h3>
<p>本程序在查询单词释义时使用本地 sqlite 数据库，数据库源于 <a href="https://github.com/skywind3000/ECDICT-ultimate" target="_blank" rel="noopener noreferrer">ecdict-ultimate</a></p>
<p>鉴于开源数据库过于巨大，且存在一些本程序无需使用的 columns，我又使用 dart 和 <a href="https://pub.dev/packages/drift" target="_blank" rel="noopener noreferrer">drift</a> 对其进行了清洗和剪裁</p>
<p>在查询时，本程序会将查询的本文串“打散”，并一齐请求数据库，以期能命中不断千变万化的英语单词：</p>
<div class="language-dart codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-dart codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">final sequence = &quot;qwertyuiopasdfghjkl&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">final sequences = [&quot;qwe&quot;,&quot;wer&quot;,&quot;ert&quot;,...,&quot;qwer&quot;,&quot;wert&quot;,...,&quot;qwert&quot;,...,&quot;qwertyuiopasdfghjkl&quot;];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">final List&lt;QueryResult&gt; results = await queryDB(keys:sequences); // average latency: ~6ms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在请求完成后，本程序会对请求结果进行去重，逻辑如下：</p>
<ul>
<li>结果中包含 owl (猫头鹰)</li>
<li>结果中包含 knowledge(知识)</li>
<li>序列 &quot;knowledge&quot; 包含 &quot;owl&quot;，移除查询结果中的 owl</li>
</ul>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>备注</div><div class="admonitionContent_BuS1"><p>目前，该逻辑还没有实现对冲突的判定：如向数据库查询的 key 为 <code>&quot;gitignore&quot;</code>，查询结果为 <code>[&quot;git&quot;, &quot;tig&quot;, &quot;ignore&quot;]</code>，目前这三个结果都会被渲染到 HUD 上。但显然，选取 git 和 ignore 这两个查询结果造成的 “冲突” 是最小的</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="发音">发音<a href="#发音" class="hash-link" aria-label="发音的直接链接" title="发音的直接链接">​</a></h3>
<p>本程序使用 <a href="https://developer.apple.com/documentation/avfoundation/speech_synthesis" target="_blank" rel="noopener noreferrer">AVFoundation - Speech synthesis</a> API 来实时合成语音</p>
<p>该 API 可以同时在 iOS/macOS 上使用，且发音较为准确，以我自身的能力(全国大学英语四级)来看，效果还算满意，确实比我的发音准 🤣</p>
<p>当然，后继如果有更高的需求，也有很多其他可选方案</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/valo-reader-doc/blog/tags/technical">technical</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/blog/tech_detail_macos.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="博文分页导航"><a class="pagination-nav__link pagination-nav__link--next" href="/valo-reader-doc/blog/motivation"><div class="pagination-nav__sublabel">较旧一篇</div><div class="pagination-nav__label">开发目的</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#摘要" class="table-of-contents__link toc-highlight">摘要</a></li><li><a href="#什么是-valo-reader" class="table-of-contents__link toc-highlight">什么是 Valo Reader?</a></li><li><a href="#项目布局" class="table-of-contents__link toc-highlight">项目布局</a></li><li><a href="#工程架构" class="table-of-contents__link toc-highlight">工程架构</a><ul><li><a href="#flutter-侧" class="table-of-contents__link toc-highlight">flutter 侧</a></li><li><a href="#native-侧" class="table-of-contents__link toc-highlight">native 侧</a></li></ul></li><li><a href="#运行时功能模块" class="table-of-contents__link toc-highlight">运行时功能模块</a><ul><li><a href="#释义展示面板-hud" class="table-of-contents__link toc-highlight">释义展示面板 (HUD)</a></li><li><a href="#用户设置面板-dashboard" class="table-of-contents__link toc-highlight">用户设置面板 (Dashboard)</a></li><li><a href="#原生侧-native" class="table-of-contents__link toc-highlight">原生侧 (native)</a></li></ul></li><li><a href="#技术细节" class="table-of-contents__link toc-highlight">技术细节</a><ul><li><a href="#多屏幕" class="table-of-contents__link toc-highlight">多屏幕</a></li><li><a href="#屏幕捕捉" class="table-of-contents__link toc-highlight">屏幕捕捉</a></li><li><a href="#ocr" class="table-of-contents__link toc-highlight">OCR</a></li><li><a href="#结果解析分词与定位" class="table-of-contents__link toc-highlight">结果解析，分词与定位</a></li><li><a href="#多引擎与状态同步" class="table-of-contents__link toc-highlight">多引擎与状态同步</a></li><li><a href="#释义查询" class="table-of-contents__link toc-highlight">释义查询</a></li><li><a href="#发音" class="table-of-contents__link toc-highlight">发音</a></li></ul></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">文档</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/valo-reader-doc/docs/intro">相关文档</a></li></ul></div><div class="col footer__col"><div class="footer__title">交流与反馈</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">微信群<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 王策</div></div></div></footer></div>
</body>
</html>